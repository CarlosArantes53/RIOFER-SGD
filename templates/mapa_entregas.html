{% extends "layout.html" %}

{% block title %}Mapa de Entregas{% endblock %}

{% block content %}
<style>
    .map-container {
        display: flex;
        height: 80vh; /* 80% da altura da tela */
    }
    .sidebar {
        width: 25%; /* Aumentado para 25% para melhor visualização */
        height: 100%;
        overflow-y: auto;
        background-color: var(--secondary-bg);
        padding: 1rem;
        border-right: 1px solid var(--border-color);
    }
    #map {
        width: 75%;
        height: 100%;
    }
    .pedido-item {
        padding: 0.8rem;
        border-bottom: 1px solid var(--border-color);
        cursor: pointer;
        transition: background-color 0.2s;
    }
    .pedido-item:hover {
        background-color: var(--primary-bg);
    }
    .pedido-item h4 { margin: 0 0 0.3rem; font-size: 1rem; }
    .pedido-item p { margin: 0; font-size: 0.85rem; color: var(--text-secondary); }
    .geo-error {
        color: var(--accent-color);
        font-weight: bold;
    }
    .pedido-item .actions { margin-top: 8px; display: flex; gap: 8px; }
    .status-text { font-style: italic; color: var(--text-secondary); }
    .edit-form { display: none; margin-top: 10px; background-color: var(--primary-bg); padding: 10px; border-radius: 8px; }
    .edit-form input { width: calc(50% - 10px); }
</style>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
    <button id="find-all-btn" class="btn">Buscar Geolocalizações Faltantes</button>
</div>
<div class="map-container box-container">
    <div class="sidebar">
        {% for pedido in pedidos %}
            <div class="pedido-item" id="pedido-{{ pedido.AbsEntry }}" data-absentry="{{ pedido.AbsEntry }}" data-lat="{{ pedido.Latitude }}" data-lon="{{ pedido.Longitude }}">
                <h4>{{ pedido.CardName }}</h4>
                <p><strong>Pedido:</strong> {{ pedido.AbsEntry }}</p>
                <p><strong>Status:</strong> {{ pedido.Status }}</p>
                <div class="geo-status">
                    {% if pedido.GeoError %}
                        <p class="geo-error">Geolocalização pendente.</p>
                    {% else %}
                        <p style="color: #10b981;">Geolocalização OK.</p>
                    {% endif %}
                </div>
                <div class="actions">
                    {% if pedido.GeoError %}
                        <button class="btn btn-secondary btn-find-one">Buscar</button>
                    {% endif %}
                    <button class="btn btn-secondary btn-edit">Editar</button>
                </div>
                <div class="edit-form">
                    <input type="text" placeholder="Latitude" value="{{ pedido.Latitude or '' }}">
                    <input type="text" placeholder="Longitude" value="{{ pedido.Longitude or '' }}">
                    <button class="btn btn-save-geo">Salvar</button>
                </div>
            </div>
        {% endfor %}
    </div>
    <div id="map"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    // Coordenadas do centro do Brasil para iniciar o mapa
    const initialCoords = [-14.2350, -51.9253];
    const map = L.map('map').setView(initialCoords, 4);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    const locations = JSON.parse('{{ locations_json|safe }}');
    const markers = {};

    locations.forEach(loc => {
        if (loc.Latitude && loc.Longitude) {
            const marker = L.marker([loc.Latitude, loc.Longitude]).addTo(map);
            marker.bindPopup(`<b>${loc.CardName}</b><br>Pedido: ${loc.AbsEntry}<br>Status: ${loc.Status}`);
            markers[loc.AbsEntry] = marker;
        }
    });

    async function fetchGeo(absEntry, statusElement) {
        statusElement.innerHTML = `<p class="status-text">Procurando geolocalização...</p>`;
        try {
            const response = await fetch(`/mapa/find_geolocation/${absEntry}`, {
                method: 'POST',
                headers: { 'X-CSRFToken': csrf_token }
            });
            const result = await response.json();
            if (result.status === 'success') {
                statusElement.innerHTML = `<p style="color: #10b981;">Encontrada!</p>`;
                // Atualizar o mapa e os dados do item
                updateItemData(absEntry, result.lat, result.lon);
            } else if (result.status === 'not_found') {
                statusElement.innerHTML = `<p class="geo-error">Não encontrada.</p>`;
            } else {
                statusElement.innerHTML = `<p class="geo-error">Erro na busca.</p>`;
            }
        } catch (error) {
            statusElement.innerHTML = `<p class="geo-error">Erro de conexão.</p>`;
        }
    }

    if (locations.length > 0) {
        const group = new L.featureGroup(Object.values(markers));
        map.fitBounds(group.getBounds().pad(0.5));
    }

    // Adicionar interatividade à barra lateral
    document.querySelectorAll('.pedido-item').forEach(item => {
        item.addEventListener('click', function() {
            const lat = this.dataset.lat;
            const lon = this.dataset.lon;
            const absEntry = this.querySelector('p').textContent.split(': ')[1];

            if (lat && lon && lat !== 'None' && lon !== 'None') {
                map.flyTo([lat, lon], 15); // Zoom de 15 no marcador
                if (markers[absEntry]) {
                    markers[absEntry].openPopup();
                }
            }
        });
    });
    // Botão para buscar todas as geolocalizações faltantes
    document.getElementById('find-all-btn').addEventListener('click', async function() {
        this.disabled = true;
        this.textContent = "Buscando...";
        const itemsToFind = document.querySelectorAll('.geo-error');
        for (const item of itemsToFind) {
            const container = item.closest('.pedido-item');
            const absEntry = container.dataset.absentry;
            await fetchGeo(absEntry, container.querySelector('.geo-status'));
        }
        this.disabled = false;
        this.textContent = "Buscar Geolocalizações Faltantes";
    });

    // Botões individuais de busca
    document.querySelectorAll('.btn-find-one').forEach(btn => {
        btn.addEventListener('click', function() {
            const container = this.closest('.pedido-item');
            const absEntry = container.dataset.absentry;
            fetchGeo(absEntry, container.querySelector('.geo-status'));
            this.style.display = 'none'; // Esconde o botão após o clique
        });
    });

    // Lógica para editar
    document.querySelectorAll('.btn-edit').forEach(btn => {
        btn.addEventListener('click', function() {
            const form = this.closest('.pedido-item').querySelector('.edit-form');
            form.style.display = form.style.display === 'none' ? 'block' : 'none';
        });
    });

    // Lógica para salvar
    document.querySelectorAll('.btn-save-geo').forEach(btn => {
        btn.addEventListener('click', async function() {
            const container = this.closest('.pedido-item');
            const absEntry = container.dataset.absentry;
            const latInput = container.querySelector('input[placeholder="Latitude"]');
            const lonInput = container.querySelector('input[placeholder="Longitude"]');
            
            const response = await fetch('/mapa/save_geolocation', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrf_token },
                body: JSON.stringify({ abs_entry: absEntry, lat: latInput.value, lon: lonInput.value })
            });
            const result = await response.json();
            if (result.status === 'success') {
                alert('Salvo com sucesso!');
                updateItemData(absEntry, latInput.value, lonInput.value);
                container.querySelector('.edit-form').style.display = 'none';
            } else {
                alert('Erro ao salvar: ' + result.message);
            }
        });
    });

    function updateItemData(absEntry, lat, lon) {
        const itemElement = document.getElementById(`pedido-${absEntry}`);
        itemElement.dataset.lat = lat;
        itemElement.dataset.lon = lon;
        itemElement.querySelector('.geo-status').innerHTML = `<p style="color: #10b981;">Geolocalização OK.</p>`;
        // Adicionar ou mover marcador no mapa
        if(markers[absEntry]) {
            markers[absEntry].setLatLng([lat, lon]);
        } else {
            const marker = L.marker([lat, lon]).addTo(map);
            // ... (precisaria dos dados do popup aqui, simplificado por agora)
            marker.bindPopup(`<b>Pedido ${absEntry}</b>`);
            markers[absEntry] = marker;
        }
        map.flyTo([lat, lon], 15);
    }
});
</script>
{% endblock %}