{% extends "layout.html" %}

{% block title %}Pedidos{% endblock %}

{% block content %}
    
    <table class="table-users">
        <thead>
            <tr>
                <th>N¬∞ Picking</th>
                <th>Localiza√ß√£o</th>
                <th>Cliente</th>
                <th>Tipo de Entrega</th>
                <th>Cidade</th>
                <th>Status</th>
                <th>A√ß√µes</th>
            </tr>
        </thead>
        <tbody>
            {% for grupo in pedidos_agrupados %}
                {% set outer_loop = loop %}
                {% set bar_colors = ['#EFB410', '#4a5568'] %} {# gold and gray #}
                {% set row_colors = ['var(--primary-bg)', 'var(--secondary-bg)'] %}
                {% for local in grupo.locations %}
                    <tr style="background-color: {{ loop.cycle(row_colors[0], row_colors[1]) if grupo.locations|length > 1 else 0 }};">
                        {% if loop.first %}
                            <td rowspan="{{ grupo.locations|length }}" class="abs-entry-cell">
                                <div class="vertical-bar" style="background-color: {{ bar_colors[outer_loop.index0 % 2] }};"></div>
                                {{ grupo.AbsEntry }}
                            </td>
                        {% endif %}
                        
                        <td>{{ local.Localizacao }}</td>
                        <td>{{ grupo.CardName }}</td>
                        <td>
                            {% if grupo['U_TU_QuemEntrega'] == '01' %}
                                üöö Entrega
                            {% elif grupo['U_TU_QuemEntrega'] == '02' %}
                                üì¶ Retirada
                            {% else %}
                                {{ grupo['U_TU_QuemEntrega'] }}
                            {% endif %}
                        </td>
                        <td>{{ grupo.U_GI_Cidade }}</td>
                        <td>{{ local.Status }}</td>
                        <td>
                            <div class="action-buttons">
                                <a href="{{ url_for('pedidos.visualizar_picking', abs_entry=grupo.AbsEntry, localizacao=local.Localizacao) }}" class="btn">Visualizar</a>
                                
                                {% set status = local.Status %}
                                {% set user_in_separation = local.UserInSeparation %}
                                
                                {% if 'Em separa√ß√£o' in status and user_in_separation == session.user['email'] %}
                                    <a href="{{ url_for('pedidos.separar_picking', abs_entry=grupo.AbsEntry, localizacao=local.Localizacao) }}" class="btn">Continuar Separa√ß√£o</a>
                                {% elif 'Em separa√ß√£o' in status %}
                                    <button class="btn" disabled>Em separa√ß√£o</button>

                                {% elif status == 'Aguardando Packing' %}
                                    <a href="{{ url_for('packing.iniciar_packing', abs_entry=grupo.AbsEntry, localizacao=local.Localizacao) }}" class="btn">Iniciar Packing</a>
                                
                                {% elif status == 'Packing Finalizado' %}
                                    <button class="btn" disabled>Conclu√≠do</button>
                                
                                {% else %} {# Caso padr√£o para Status == 'Pendente' #}
                                    <a href="{{ url_for('pedidos.iniciar_separacao', abs_entry=grupo.AbsEntry, localizacao=local.Localizacao) }}" class="btn">Iniciar Separa√ß√£o</a>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                {% endfor %}
            {% endfor %}
        </tbody>
    </table>
{% endblock %}