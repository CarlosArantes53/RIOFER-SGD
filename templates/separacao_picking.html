{% extends "layout.html" %}

{% block title %}Separação do Picking {{ abs_entry }} - {{ localizacao }}{% endblock %}

{% block content %}
    <h1>Separação do Pedido {{ abs_entry }} - Localização {{ localizacao }}</h1>
    
    <div class="user-form">
        <form method="post">
            <table class="table-users">
                <thead>
                    <tr>
                        <th>Cód. Item</th>
                        <th>Descrição</th>
                        <th>Qtd. Pedido</th>
                        <th>Qtd. Separada</th>
                        <th>Qtd. Pendente</th>
                        <th>Qtd. para o Pacote</th>
                        <th>Peso (kg)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in items %}
                    <tr>
                        <td>{{ item.ItemCode }}</td>
                        <td>{{ item.ItemName }}</td>
                        <td>{{ item.RelQtty }}</td>
                        <td>{{ quantidades_separadas.get(item.ItemCode, 0) }}</td>
                        <td>{{ item.RelQtty - quantidades_separadas.get(item.ItemCode, 0) }}</td>
                        <td><input type="number" step="any" name="quantidade_{{ item.ItemCode }}" placeholder="0" class="quantidade-input" data-weight="{{ item.SWeight1 }}"></td>
                        <td class="peso-calculado">0.00</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            
            <div class="input-group" style="margin-top: 20px;">
                <label for="peso_pacote">Peso do Pacote (kg):</label>
                <input type="number" step="any" id="peso_pacote" name="peso_pacote" required>
            </div>

            <div class="input-group">
                <label for="report">Observação:</label>
                <textarea id="report" name="report" rows="3"></textarea>
            </div>

            <div class="input-group">
                <label for="localizacao">Localização:</label>
                <select id="localizacao" name="localizacao">
                    <option value="Doca 1">Doca 1</option>
                    <option value="Doca 2">Doca 2</option>
                    <option value="Doca 3">Doca 3</option>
                </select>
            </div>

            <button type="submit" class="btn">Criar Pacote</button>
        </form>
    </div>

    <div style="margin-top: 40px;">
        <h2>Pacotes Criados</h2>
        {% if pacotes %}
            {% for pacote in pacotes %}
                <div class="box-container" style="margin-bottom: 20px;">
                    <h3>Pacote {{ pacote.id }} - Peso: {{ pacote.peso }} kg - Local: {{ pacote.localizacao }}</h3>
                    {% if pacote.report %}
                        <p><strong>Observação:</strong> {{ pacote.report }}</p>
                    {% endif %}
                    <ul>
                        {% for item in pacote.itens %}
                            <li>{{ item.ItemName }} ({{ item.ItemCode }}) - Qtd: {{ item.Quantity }}</li>
                        {% endfor %}
                    </ul>
                    <div class="action-buttons">
                        <a href="#" class="btn btn-secondary">Editar</a>
                        <a href="#" class="btn btn-danger" onclick="return confirm('Tem certeza que deseja excluir este pacote?');">Excluir</a>
                    </div>
                </div>
            {% endfor %}
            <a href="{{ url_for('pedidos.finalizar_separacao', abs_entry=abs_entry, localizacao=localizacao) }}" class="btn">Finalizar Separação</a>
        {% else %}
            <p>Nenhum pacote criado ainda.</p>
        {% endif %}
    </div>

{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const quantidadeInputs = document.querySelectorAll('.quantidade-input');
        quantidadeInputs.forEach(input => {
            input.addEventListener('input', (e) => {
                const weight = parseFloat(e.target.dataset.weight) || 0;
                const quantity = parseFloat(e.target.value) || 0;
                const pesoCalculadoCell = e.target.closest('tr').querySelector('.peso-calculado');
                pesoCalculadoCell.textContent = (weight * quantity).toFixed(2);
            });
        });
    });
</script>
{% endblock %}