{% extends "layout.html" %}

{% block title %}Separação do Picking {{ abs_entry }} - {{ localizacao }}{% endblock %}

{% block content %}
    <div class="box-container">
        <h1>Separação do Pedido {{ abs_entry }} - Localização {{ localizacao }}</h1>
        
        <div class="user-form">
            <form method="post">
                <table class="table-users">
                    <thead>
                        <tr>
                            <th>Cód. Item</th>
                            <th>Descrição</th>
                            <th>Qtd. Pedido</th>
                            <th>Qtd. Separada</th>
                            <th>Qtd. Pendente</th>
                            <th>Unidade</th>
                            <th>Qtd. para o Pacote</th>
                            <th>Peso (kg)</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in items %}
                        <tr>
                            <td>{{ item.ItemCode }}</td>
                            <td>{{ item.ItemName }}</td>
                            <td>{{ "%.3f"|format(item.RelQtty|float) }}</td>
                            <td>{{ "%.3f"|format(quantidades_separadas.get(item.ItemCode, 0)|float) }}</td>
                            <td>{{ "%.3f"|format(item.RelQtty - quantidades_separadas.get(item.ItemCode, 0)) }}</td>
                            <td>{{ item.UomCode }}</td>
                            <td>
                                {% set step = '0.001' if item.UomCode == 'KG' else '1' %}
                                <input type="number" step="{{ step }}" min="0" name="quantidade_{{ item.ItemCode }}" placeholder="0" class="quantidade-input" data-weight="{{ item.SWeight1 }}">
                            </td>
                            <td class="peso-calculado">0.00</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                
                <div class="form-grid" style="margin-top: 20px;">
                    <div class="input-group">
                        <label for="peso_pacote">Peso do Pacote (kg):</label>
                        <input type="number" step="any" id="peso_pacote" name="peso_pacote" required>
                    </div>

                    <div class="input-group">
                        <label for="localizacao">Localização:</label>
                        <select id="localizacao" name="localizacao">
                            <option value="Doca 1">Doca 1</option>
                            <option value="Doca 2">Doca 2</option>
                            <option value="Doca 3">Doca 3</option>
                        </select>
                    </div>

                    <div class="input-group full-width">
                        <label for="report">Observação:</label>
                        <textarea id="report" name="report" rows="3"></textarea>
                    </div>
                </div>

                <button type="submit" class="btn" style="margin-top: 1rem;">Criar Pacote</button>
            </form>
        </div>
    </div>

    <div style="margin-top: 40px;">
        <h2>Pacotes Criados</h2>
        {% if pacotes %}
            {% for pacote in pacotes %}
                <div class="pedido-card" style="margin-bottom: 20px; cursor: default;">
                    <div class="card-header" style="padding-bottom: 0.5rem; margin-bottom: 1rem;">
                        <h3 class="card-title">Pacote {{ pacote.id }}</h3>
                        <div class="card-meta">
                           <span><strong>Peso:</strong> {{ pacote.peso }} kg</span>
                           <span><strong>Local:</strong> {{ pacote.localizacao }}</span>
                        </div>
                    </div>
                    {% if pacote.report %}
                        <p><strong>Observação:</strong> {{ pacote.report }}</p>
                    {% endif %}
                    <ul>
                    {% for item in pacote.itens %}
                        <li>{{ item.ItemName }} ({{ item.ItemCode }}) - Qtd: {{ item.Quantity }} {{ item.UomCode }}</li>
                    {% endfor %}
                </ul>
                    <div class="action-buttons" style="margin-top: 1rem;">
                        <a href="{{ url_for('pedidos.editar_pacote_sessao', abs_entry=abs_entry, localizacao=localizacao, pacote_id=pacote.id) }}" class="btn btn-secondary">Editar</a>
                        <a href="{{ url_for('pedidos.excluir_pacote_sessao', abs_entry=abs_entry, localizacao=localizacao, pacote_id=pacote.id) }}" class="btn btn-danger" onclick="return confirm('Tem certeza que deseja excluir este pacote?');">Excluir</a>
                    </div>
                </div>
            {% endfor %}
            
            <div class="box-container" style="margin-top: 2rem;">
                <h3>Finalizar Separação</h3>
                <form id="finalizar-separacao-form" action="{{ url_for('pedidos.finalizar_separacao', abs_entry=abs_entry, localizacao=localizacao) }}" method="post">
                    <input type="hidden" name="confirm_incomplete" id="confirm_incomplete" value="">
                    <div class="input-group">
                        <label for="discrepancy_report">Justificativa de Divergência (Furo de Estoque):</label>
                        <textarea id="discrepancy_report" name="discrepancy_report" rows="3" placeholder="Se houver itens faltantes ou com quantidade parcial, justifique aqui..."></textarea>
                    </div>
                    <button type="submit" class="btn">Finalizar Separação</button>
                </form>
            </div>

        {% else %}
            <div class="box-container" style="text-align: center;">
                <p>Nenhum pacote criado ainda. Crie ao menos um pacote para poder finalizar a separação.</p>
            </div>
        {% endif %}
    </div>

{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const quantidadeInputs = document.querySelectorAll('.quantidade-input');
        quantidadeInputs.forEach(input => {
            input.addEventListener('input', (e) => {
                const weight = parseFloat(e.target.dataset.weight) || 0;
                const quantity = parseFloat(e.target.value) || 0;
                const pesoCalculadoCell = e.target.closest('tr').querySelector('.peso-calculado');
                pesoCalculadoCell.textContent = (weight * quantity).toFixed(2);
            });
        });

        const finalizarForm = document.getElementById('finalizar-separacao-form');
        if (finalizarForm) {
            finalizarForm.addEventListener('submit', function(event) {
                event.preventDefault(); // Impede o envio padrão do formulário

                const quantidadesSeparadas = JSON.parse('{{ quantidades_separadas|tojson|safe }}');
                const itemsPedido = JSON.parse('{{ items|tojson|safe }}');
                let isIncomplete = false;
                let discrepancyMessage = 'Atenção: A separação está incompleta para os seguintes itens:\n\n';

                itemsPedido.forEach(item => {
                    const pedido = parseFloat(item.RelQtty);
                    const separado = parseFloat(quantidadesSeparadas[item.ItemCode] || 0);

                    if (separado < pedido) {
                        isIncomplete = true;
                        discrepancyMessage += `- ${item.ItemName} (${item.ItemCode}): Pedido: ${pedido}, Separado: ${separado}\n`;
                    }
                });

                if (isIncomplete) {
                    discrepancyMessage += '\nDeseja mesmo finalizar a separação com itens faltantes? O picking será marcado como "Incompleto" e não poderá seguir para o packing até ser regularizado.';
                    if (confirm(discrepancyMessage)) {
                        document.getElementById('confirm_incomplete').value = 'true';
                        finalizarForm.submit();
                    }
                } else {
                    finalizarForm.submit();
                }
            });
        }
    });
</script>
{% endblock %}